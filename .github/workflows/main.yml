name: Run Jmeter File

on:
# Set your workflow to run every day of the week from Monday to Friday at 2:00 UTC
  schedule:
  - cron: "0 2 * * 1-5"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "runPFTest"
  runPFTest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v1
        with:
          java-version: '8.0.282'
          java-package: jdk
          architecture: x64
      - name: check JAVA version
        run:
          java -version
      - name: install jmeter
        env:
          JMETER_VERSION: 5.5
        run: |
          wget --no-verbose --no-check-certificate -O /tmp/apache-jmeter.tgz https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-$JMETER_VERSION.tgz
          cd /tmp && tar -xvf apache-jmeter.tgz
          echo "jmeter.save.saveservice.output_format=xml" >> /tmp/apache-jmeter-$JMETER_VERSION/bin/jmeter.properties
          echo "jmeter.save.saveservice.response_data.on_error=true" >> /tmp/apache-jmeter-$JMETER_VERSION/bin/jmeter.properties
          ln -s /tmp/apache-jmeter-$JMETER_VERSION /opt/jmeter
          mkdir /home/runner/work/PerformanceTesting/PerformanceTesting/jmeter_report/PerfTestReport
          
      - name: run jmeter
        run: |
          /opt/jmeter/bin/jmeter.sh \
          -Jjmeter.save.saveservice.output_format=xml -n \
          -t *.jmx \
          -l jmeter_logs/pf.jtl \
          -e \
          -o jmeter_report/PerfTestReport
          -j jmeter_logs/pf.log
          
      - name: check logs
        run: |
          if cat jmeter_logs/pf.log | grep -e '<failure>true</failure>' > /dev/n
            echo "check logs filed"
            exit 1
          fi
      - uses: actions/upload-artifact@v1
        if: failure()
        with:
          name: jmeter_logs_pf
          path: ./jmeter_logs
      
